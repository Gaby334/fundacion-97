<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Fundación 97</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1b7898",
                        "primary-dark": "#125a73",
                        "secondary": "#9FD49C",
                        "accent": "#E3B24F",
                        "background-light": "#f8fafc",
                        "surface-light": "#ffffff",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"],
                        "mono": ["ui-monospace", "SFMono-Regular", "Menlo", "Monaco", "Consolas", "monospace"]
                    }
                }
            }
        }
    </script>
    
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .icon-filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #e2e8f0;
            border-radius: 20px;
        }
    </style>
</head>

<body class="bg-background-light text-slate-800 font-display min-h-screen flex overflow-hidden">
    
    <!-- Sidebar -->
    <aside class="w-64 bg-surface-light border-r border-slate-200 hidden md:flex flex-col z-20 h-screen sticky top-0">
        <div class="p-6 flex items-center gap-3">
            <div class="size-10 rounded-xl bg-primary flex items-center justify-center text-white shadow-lg shadow-primary/30">
                <span class="material-symbols-outlined text-2xl icon-filled">favorite</span>
            </div>
            <div class="flex flex-col">
                <h1 class="text-slate-900 text-lg font-bold leading-tight tracking-tight">Fundación 97</h1>
                <p class="text-slate-500 text-xs font-medium">Transparency First</p>
            </div>
        </div>
        
        <nav class="flex-1 px-4 py-4 flex flex-col gap-2 overflow-y-auto">
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 text-primary" href="dashboard.html">
                <span class="material-symbols-outlined icon-filled">dashboard</span>
                <span class="text-sm font-semibold">Overview</span>
            </a>
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors" href="tracker.html">
                <span class="material-symbols-outlined">volunteer_activism</span>
                <span class="text-sm font-medium">My Donations</span>
            </a>
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors" href="proyectos.html">
                <span class="material-symbols-outlined">map</span>
                <span class="text-sm font-medium">Projects</span>
            </a>
            <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 hover:bg-slate-50 transition-colors" href="#">
                <span class="material-symbols-outlined">account_balance_wallet</span>
                <span class="text-sm font-medium">Wallet</span>
            </a>
        </nav>
        
        <div class="p-4 border-t border-slate-100">
            <div class="bg-slate-50 rounded-xl p-4 border border-slate-100">
                <div class="flex items-center gap-3 mb-3">
                    <div id="userAvatar" class="size-8 rounded-full bg-primary flex items-center justify-center text-white font-bold">
                        ?
                    </div>
                    <div class="flex flex-col min-w-0">
                        <p id="userName" class="text-sm font-bold text-slate-900 truncate">Conectar Wallet</p>
                        <p id="userLevel" class="text-xs text-slate-500 truncate">No conectado</p>
                    </div>
                </div>
                <button id="logoutBtn" class="hidden w-full text-xs font-semibold text-slate-600 hover:text-primary transition-colors flex items-center gap-1">
                    <span class="material-symbols-outlined text-[16px]">logout</span> Desconectar
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
        
        <!-- Top Header -->
        <header class="h-16 bg-surface-light border-b border-slate-200 flex items-center justify-between px-6 shrink-0 z-10">
            <div class="flex items-center gap-2 text-slate-500">
                <span class="material-symbols-outlined text-xl">home</span>
                <span class="text-slate-300">/</span>
                <span class="text-sm font-medium text-slate-900">Dashboard</span>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="networkStatus" class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-slate-100 text-slate-600 rounded-full border border-slate-200">
                    <div class="size-2 rounded-full bg-slate-400"></div>
                    <span class="text-xs font-bold">No conectado</span>
                </div>
                
                <div class="h-8 w-[1px] bg-slate-200 mx-1"></div>
                
                <div class="flex items-center gap-3">
                    <div class="hidden sm:flex flex-col items-end mr-2">
                        <span class="text-xs font-medium text-slate-500">Balance</span>
                        <span id="walletBalance" class="text-sm font-bold text-slate-900">-</span>
                    </div>
                    
                    <button id="connectWalletBtn" class="flex items-center gap-2 pl-3 pr-2 py-1.5 bg-primary hover:bg-primary-dark transition-colors rounded-lg text-white shadow-lg shadow-primary/20">
                        <span class="material-symbols-outlined text-lg">account_balance_wallet</span>
                        <span class="text-sm font-bold">Conectar</span>
                    </button>
                    
                    <button id="walletInfo" class="hidden items-center gap-2 pl-3 pr-2 py-1.5 bg-slate-100 hover:bg-slate-200 transition-colors rounded-lg border border-slate-200">
                        <span class="size-5 rounded-full bg-gradient-to-tr from-blue-500 to-primary"></span>
                        <span id="walletAddress" class="text-sm font-bold text-slate-700 font-mono">0x...</span>
                        <span class="material-symbols-outlined text-slate-400 text-lg">expand_more</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto custom-scroll p-6 lg:p-10">
            <div class="max-w-7xl mx-auto flex flex-col gap-8">
                
                <!-- Stats Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- Stat 1 -->
                    <div class="bg-surface-light rounded-xl p-6 shadow-lg border border-slate-100 flex flex-col justify-between h-40 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                            <span class="material-symbols-outlined text-6xl text-primary">payments</span>
                        </div>
                        <div>
                            <p class="text-slate-500 font-medium text-sm mb-1">Total Contributed</p>
                            <h3 id="totalContributed" class="text-3xl font-extrabold text-slate-900 tracking-tight">$0.00</h3>
                        </div>
                        <div class="flex items-center gap-1 text-green-600 text-sm font-bold mt-auto">
                            <span class="material-symbols-outlined text-lg">trending_up</span>
                            <span id="contributionGrowth">+0%</span>
                        </div>
                    </div>
                    
                    <!-- Stat 2 -->
                    <div class="bg-surface-light rounded-xl p-6 shadow-lg border border-slate-100 flex flex-col justify-between h-40 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                            <span class="material-symbols-outlined text-6xl text-primary">handshake</span>
                        </div>
                        <div>
                            <p class="text-slate-500 font-medium text-sm mb-1">Projects Supported</p>
                            <h3 id="projectsSupported" class="text-3xl font-extrabold text-slate-900 tracking-tight">0</h3>
                        </div>
                        <div id="projectLogos" class="flex -space-x-2 mt-auto">
                            <!-- Project logos se cargarán aquí -->
                        </div>
                    </div>
                    
                    <!-- Stat 3 -->
                    <div class="bg-surface-light rounded-xl p-6 shadow-lg border border-slate-100 flex items-center justify-between h-40 relative overflow-hidden">
                        <div class="flex flex-col h-full justify-between z-10">
                            <div>
                                <p class="text-slate-500 font-medium text-sm mb-1">Impact Efficiency</p>
                                <div class="flex items-baseline gap-1">
                                    <h3 class="text-3xl font-extrabold text-primary tracking-tight">97%</h3>
                                    <span class="text-sm text-slate-400 font-medium">Direct</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded font-bold">Verified</span>
                            </div>
                        </div>
                        
                        <!-- Donut Chart -->
                        <div class="relative size-24 shrink-0">
                            <svg class="size-full -rotate-90" viewBox="0 0 36 36">
                                <path class="text-slate-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4"></path>
                                <path class="text-primary drop-shadow-md" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-dasharray="97, 100" stroke-linecap="round" stroke-width="4"></path>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center flex-col">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Fee</span>
                                <span class="text-xs font-bold text-slate-600">3%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Grid -->
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    
                    <!-- Left: Active Projects -->
                    <div class="xl:col-span-2 flex flex-col gap-8">
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-bold text-slate-900">Active Projects</h2>
                                <a class="text-sm font-semibold text-primary hover:text-primary-dark" href="proyectos.html">View All</a>
                            </div>
                            
                            <div id="activeProjectsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Loading state -->
                                <div class="col-span-2 text-center py-8">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
                                    <p class="text-slate-500 mt-2">Cargando proyectos...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right: Live Feed -->
                    <div class="xl:col-span-1">
                        <div class="bg-surface-light border border-slate-100 rounded-xl shadow-lg h-full flex flex-col">
                            <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="p-1.5 bg-green-50 text-green-600 rounded-lg">
                                        <span class="material-symbols-outlined text-lg">fact_check</span>
                                    </div>
                                    <h2 class="font-bold text-slate-900">Live Feed</h2>
                                </div>
                                <div class="flex items-center gap-1 text-xs text-slate-400">
                                    <span class="relative flex h-2 w-2">
                                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                                    </span>
                                    Live
                                </div>
                            </div>
                            
                            <div id="liveFeed" class="flex-1 overflow-y-auto max-h-[600px] p-2 custom-scroll">
                                <!-- Feed items se cargarán aquí -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../js/blockchain.js"></script>
    <script src="../js/ui.js"></script>
    
    <script>
        // Estado global
        let tracker = new BlockchainTracker();
        let userDonations = [];
        let projects = [];
        
        // Inicializar dashboard
        async function initDashboard() {
            await loadProjects();
            await checkWalletConnection();
            startLiveFeed();
        }
        
        // Cargar proyectos
        async function loadProjects() {
            try {
                const response = await fetch('../data/proyectos.json');
                const data = await response.json();
                projects = data.projects;
                renderActiveProjects(projects.slice(0, 2)); // Mostrar solo 2
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Renderizar proyectos activos
        function renderActiveProjects(projectsList) {
            const grid = document.getElementById('activeProjectsGrid');
            grid.innerHTML = projectsList.map(project => {
                const percentage = Math.round((project.raised / project.goal) * 100);
                return `
                    <div class="bg-surface-light border border-slate-100 rounded-xl p-4 shadow-lg hover:shadow-xl transition-all">
                        <div class="h-40 rounded-lg bg-cover bg-center mb-4 relative" style="background-image: url('${project.image}');">
                            <div class="absolute top-3 right-3 bg-white/90 px-2 py-1 rounded text-xs font-bold text-slate-800">
                                ${project.category}
                            </div>
                        </div>
                        <h3 class="font-bold text-lg text-slate-900 mb-1">${project.title}</h3>
                        <p class="text-slate-500 text-sm mb-4 line-clamp-2">${project.shortDescription}</p>
                        
                        <div class="flex justify-between text-xs font-semibold mb-2">
                            <span class="text-primary">${formatCurrency(project.raised)}</span>
                            <span class="text-slate-400">Meta: ${formatCurrency(project.goal)}</span>
                        </div>
                        
                        <div class="w-full bg-slate-100 rounded-full h-2 mb-4 overflow-hidden">
                            <div class="bg-primary h-2 rounded-full transition-all duration-1000" style="width: ${percentage}%"></div>
                        </div>
                        
                        <button onclick="donate(${project.id})" class="w-full py-2.5 rounded-lg bg-primary text-white text-sm font-bold hover:bg-primary-dark transition-colors shadow-lg shadow-primary/20">
                            Donate Now
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        // Conectar wallet
        async function connectWallet() {
            try {
                uiManager.showLoading();
                
                await tracker.init();
                const wallet = await tracker.connectWallet();
                
                // Actualizar UI
                document.getElementById('connectWalletBtn').classList.add('hidden');
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('walletAddress').textContent = tracker.formatAddress(wallet.address);
                
                // Actualizar network status
                document.getElementById('networkStatus').className = 'flex items-center gap-2 px-3 py-1.5 bg-green-50 text-green-700 rounded-full border border-green-100';
                document.getElementById('networkStatus').innerHTML = `
                    <div class="size-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-xs font-bold">Polygon Mainnet</span>
                `;
                
                // Cargar balance
                const balance = await tracker.getBalance();
                document.getElementById('walletBalance').textContent = `${parseFloat(balance).toFixed(4)} ETH`;
                
                // Actualizar user info
                document.getElementById('userName').textContent = tracker.formatAddress(wallet.address);
                document.getElementById('userLevel').textContent = 'Connected';
                document.getElementById('userAvatar').textContent = wallet.address.substring(2, 4).toUpperCase();
                document.getElementById('logoutBtn').classList.remove('hidden');
                
                // Cargar donaciones del usuario
                await loadUserDonations();
                
                uiManager.hideLoading();
                uiManager.showNotification('Wallet conectada correctamente', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                uiManager.hideLoading();
                uiManager.showNotification('Error conectando wallet', 'error');
            }
        }
        
        // Verificar si ya hay wallet conectada
        async function checkWalletConnection() {
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    await connectWallet();
                }
            }
        }
        
        // Cargar donaciones del usuario
        async function loadUserDonations() {
            try {
                const donations = await tracker.getUserDonations();
                userDonations = donations;
                
                // Actualizar stats
                const totalContributed = donations.reduce((sum, d) => sum + d.amount, 0);
                document.getElementById('totalContributed').textContent = formatCurrency(totalContributed);
                document.getElementById('projectsSupported').textContent = donations.length;
                
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Live Feed
        function startLiveFeed() {
            const feedContainer = document.getElementById('liveFeed');
            const mockFeed = [
                { address: '0x8a...2b91', action: 'Donated 500 USDC', project: 'Clean Water', time: '2 min ago', type: 'donation' },
                { address: '0x71...f432', action: 'Donated 1,200 MATIC', project: 'School Rebuild', time: '14 min ago', type: 'donation' },
                { address: '0x3d...99aa', action: 'Milestone Unlocked', project: 'Foundation Laid', time: '45 min ago', type: 'milestone' }
            ];
            
            feedContainer.innerHTML = mockFeed.map(item => `
                <div class="p-3 hover:bg-slate-50 rounded-lg transition-colors cursor-pointer border border-transparent hover:border-slate-100 mb-1">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-mono text-slate-400">${item.address}</span>
                        <span class="text-xs text-slate-400">${item.time}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-bold text-slate-900">${item.action}</p>
                            <p class="text-xs text-slate-500">to ${item.project}</p>
                        </div>
                        <div class="size-8 rounded-full ${item.type === 'donation' ? 'bg-green-50 text-green-600' : 'bg-blue-50 text-blue-600'} flex items-center justify-center">
                            <span class="material-symbols-outlined text-lg">${item.type === 'donation' ? 'check_circle' : 'flag'}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Formatear moneda
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        // Donar
        function donate(projectId) {
            uiManager.showNotification('Función de donación próximamente', 'info');
        }
        
        // Event listeners
        document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
        document.getElementById('logoutBtn').addEventListener('click', () => {
            location.reload();
        });
        
        // Inicializar
        initDashboard();
    </script>
</body>
</html>